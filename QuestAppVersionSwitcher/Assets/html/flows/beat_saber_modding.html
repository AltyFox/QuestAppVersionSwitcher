<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QAVS - Beat Saber modding</title>
    <link rel="stylesheet" type="text/css" href="../newstyle.css">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
</head>
<body>
<div class="content" id="checking">
    <h1>Checking your current Beat Saber install</h1>
    <h3>Please wait up to 1 minute</h3>
    <div class="loaderContainer center">
        <div class="loaderBarRight"></div>
        <div class="loaderBarLeft"></div>
        <div class="loaderBarTop"></div>
        <div class="loaderBarBottom"></div>
        <div class="loaderSpinningCircle"></div>
        <div class="loaderMiddleCircle"></div>
        <div class="loaderCircleHole"></div>
        <div class="loaderSquare"></div>
    </div>
</div>
<div class="content hidden" id="modgame">
    <h1>Mod your game</h1>
    <p>
        Your installed Beat Saber version is <code id="modgamebsversion"></code>
        <br>
        You can mod this version by pressing <code>Mod my game below</code>
    </p>
    <button id="modgamebutton" onclick="PatchGame()">Mod my game</button>
    <div id="gameModProgressContainer" style="display: none;">
        <h3>Modding your game</h3>
        <div id="modgameloader" class="loaderContainer center">
            <div class="loaderBarRight"></div>
            <div class="loaderBarLeft"></div>
            <div class="loaderBarTop"></div>
            <div class="loaderBarBottom"></div>
            <div class="loaderSpinningCircle"></div>
            <div class="loaderMiddleCircle"></div>
            <div class="loaderCircleHole"></div>
            <div class="loaderSquare"></div>
        </div>
        <div style="margin-top: 10px; font-size: 1.2rem">
            Status: <code id="patchingStatus"></code>
        </div>
    </div>
</div>
<div class="content hidden" id="afterpatch">
    <h1>Install Game</h1>
    <p>Your game is almost modded. Press <code>Install game</code> below and follow the instructions to finish modding your game</p>
    <button onclick="RestoreBackup()">Install game</button>
    <br>
    <br>
    <br>
    <br>
    <button style="font-size: .7em;" onclick="ModSettings()"><i>Open modding settings</i></button>
</div>
<div class="content hidden" id="afterrestore">
    <h1>Game modded!</h1>
    <p>Your game is now modded! Press <code>Get mods</code> below to install all core mods and open the installed mods page</p>
    <button onclick="InstallCoreModsAndGetMods()">Get mods</button>
</div>
<div class="content hidden" id="alreadymodded">
    <h1>Your game is modded!</h1>
    <p>Your game is modded! Press <code>Get mods</code> below to get to the installed mods page</p>
    <button onclick="GetMods()">Get mods</button>
</div>
<div class="content hidden" id="downgrade">
    <h1>Downgrade</h1>
    <div id="downgradeLogin">
        <p>
            Your current Beat Saber version is <code class="bsVersion"></code>. This version does not support mods yet.
            <br>
            Please install the latest version of Beat Saber to downgrade your game. Then reopen QuestAppVersionSwitcher.
        </p>
    </div>
</div>
<div class="content hidden" id="downgradeDowngrade">
    <p>
        Your current Beat Saber version is <code class="bsVersion"></code>. This version does not support mods yet or is not the latest moddable version.
        <br>
        You can downgrade your game to <code class="supportedBsVersion"></code> to use mods.
        <br>
        <br>
        To downgrade your game, press the Downgrade button below.
    </p>
    <button onclick="Downgrade()">Downgrade</button>
</div>
<div class="content hidden" id="download">
    <h1>Game downloading</h1>
    <h3>Do not exit QuestAppVersionSwitcher!</h3>
    <div id="progress"></div>
</div>
<div class="content hidden" id="entitlementfailed">
    <h1>Download error</h1>
    <p>
        An unknown error has occurred
    </p>
    <button onclick="Logout()">Log out</button>
</div>
<div class="content hidden" id="downloaddone">
    <h1>Download is done!</h1>
    <p>
        Beat Saber <code id="downloadbsversion"></code> has been downloaded successfully. Press <code>Mod my game</code> to continue modding your game.
    </p>
    <button onclick="ModDowngradedGame()">Mod my game</button>
    <br>
    <br>
    <br>
    <br>
    <button style="font-size: .7em;" onclick="ModSettingsDowngradedGame()"><i>Open modding settings</i></button>
</div>
<div class="content hidden" id="offline">
    <h1>It looks like you're offline!</h1>
    <p>Please enable WiFi and restart QuestAppVersionSwitcher to continue.</p>
</div>
<div class="content hidden" id="nodowngrade">
    <h1>Quest 3 is currently not moddable with QuestAppVersionSwitcher!</h1>
    <p>The modding team is working hard to make Quest 3 modding work. In the meantime if you have a PC you can use QuestPatcher to mod your game. Please refer to discord.gg/beatsabermods (Discord Server) for more information.</p>
</div>
<div class="content hidden" id="patcheserror">
    <h1>No patches available</h1>
    <p>I could not find any downgrade patches for your current Beat Saber version. Make sure you got the latest version of Beat Saber installed.</p>
</div>
<div style="position: fixed; bottom: 10px; left: 10px;">
    <button id="showSupportButton" onclick="ShowSupport()">Help</button>
    <div id="helpSection" style="display: none;" class="box">
        <p>
            Are you stuck or need help? Join our Discord server at <code>https://discord.gg/zwRfHQN2UY</code>.
        </p>
        <h2>Upload logs</h2>
        <p>
            Uploading logs will upload info about your QAVS install to our server. This includes logs, your Beat Saber version, installed mods, <a href="https://github.com/ComputerElite/QuestAppVersionSwitcher/wiki/What-does-upload-logs-do">and more</a>.
            <br>
            You should only do this when requested to do so!
        </p>
        <button onclick="UploadLogs()">Upload logs</button>
        <br>
        <br>
        <code id="logsInfoText" class="hidden">
            
        </code>
        <button onclick="window.location = `/setup`">Go back</button>
    </div>
</div>
<script>
    const patchInProgressContainer = document.getElementById("gameModProgressContainer")
    const patchingStatus = document.getElementById("patchingStatus")
    const modgameloader = document.getElementById("modgameloader")
    const helpSection = document.getElementById("helpSection")
    const showSupportButton = document.getElementById("showSupportButton")
    const logsInfoText = document.getElementById("logsInfoText")
    
    var params = new URLSearchParams(window.location.search);
    var tab = params.get('tab');
    var checkdowngrade = params.get('checkdowngrade');
    var startDownload = params.get('startdownload');
    const start = ""
    const squareLoader = `
    <div class="loaderContainer center">
        <div class="loaderBarRight"></div>
        <div class="loaderBarLeft"></div>
        <div class="loaderBarTop"></div>
        <div class="loaderBarBottom"></div>
        <div class="loaderSpinningCircle"></div>
        <div class="loaderMiddleCircle"></div>
        <div class="loaderCircleHole"></div>
        <div class="loaderSquare"></div>
    </div>`
    
    if(tab) {
        OpenTab(tab);
    } else {
        FirstOpen()
    }
    ChangeApp("com.beatgames.beatsaber")
    

    function ChangeApp(package) {
        console.log("Changing app to " + package)
        fetch("/api/questappversionswitcher/changeapp", {
            method: "POST",
            body: JSON.stringify({packageName: package})
        })
    }
    
    function UploadLogs() {
        logsInfoText.className = ""
        logsInfoText.classList.add("text")
        logsInfoText.innerHTML = "Collecting information.. please allow us up to 30 seconds to collect everything"
        fetch("/api/questappversionswitcher/uploadlogs", {
            method: "POST",
            body: ""
        }).then(res => {
            res.json().then(j => {
                if (!j.success) {
                    logsInfoText.classList.remove("text")
                    logsInfoText.classList.add("error")
                    logsInfoText.innerHTML = j.msg
                } else {
                    logsInfoText.classList.remove("text")
                    logsInfoText.classList.add("success")
                    logsInfoText.innerHTML = "Logs uploaded successfully. Tell your support member this ID: " + j.msg
                }
            })
        })
    }
    
    function ShowSupport() {
        if(helpSection.style.display == "none") {
            helpSection.style.display = "block"
            showSupportButton.innerHTML = "Hide help"
        } else {
            helpSection.style.display = "none"
            showSupportButton.innerHTML = "Help"
        }
    }
    
    if(startDownload) StartDownloadMonitoring()
    if(checkdowngrade) CheckDowngrade()

    var patchExtras = ""
    function ModSettingsDowngradedGame() {
        location = start + `/?tab=patching&backuptopatch=${lastDownloadProgress.backupName}`
    }
    function ModSettings() {
        location = start + `/?tab=patching`
    }
    function ModDowngradedGame() {
        patchExtras = `?package=${lastDownloadProgress.packageName}&backup=${lastDownloadProgress.backupName}`
        OpenTab("modgame")
        document.getElementById("modgamebsversion").innerText = lastDownloadProgress.version
        PatchGame()
    }

    var downloadInterval;
    function FormatDownload(d) {
        return `<div class="downloadContainer">
                    <div class="downloadProgressContainer">
                        <div class="downloadProgressBar" style="width: ${d.percentage * 100}%;"></div>
                    </div>
                    <div style="color: ${d.textColor}; margin-left: 10px;">
                        <b>${d.text}</b> ${d.percentageString} ${d.doneString} / ${d.totalString} ${d.speedString} ETA ${d.eTAString}
                    </div>
                </div>`
    }
    function DownloadDone() {
        clearInterval(downloadInterval)
        OpenTab("downloaddone")
        document.getElementById("downloadbsversion").innerText = lastDownloadProgress.version
        fetch(start + "/api/cleardownloads", {method: "POST"})
    }
    var lastDownloadProgress = {}
    function StartDownloadMonitoring() {
        downloadInterval = setInterval(() => {
            fetch(start + "/api/downloads").then(res => {
                var m = ""
                var gdms = ""
                res.json().then(json => {
                    for(const d of json.individualDownloads) {
                        m += FormatDownload(d)
                    }
                    for(const d of json.gameDownloads) {
                        var downloads = ""
                        for(const download of d.downloadManagers) {
                            downloads += FormatDownload(download)
                        }
                        lastDownloadProgress = d
                        gdms += `
                            <div style="display: flex; flex-direction: column; background-color: #1F1F1F; padding: 10px;"><div class="downloadContainer">
                                <div style="color: ${d.textColor}; margin-left: 20px;">
                                    <b>${d.canceled ? "Cancelled " : ""}${d.status}</b><br>${d.filesDownloaded} / ${d.filesToDownload} files downloaded
                                </div>
                            </div>
                            ${downloads}
                            </div>`
                        if(d.entitlementError) {
                            OpenTab("entitlementfailed")
                            clearInterval(downloadInterval)
                        }
                        if(d.done) DownloadDone()
                    }
                    if (gdms == "") gdms = "<h2>No game downloads running</h2>"
                    document.getElementById("progress").innerHTML = gdms
                })
            })
        }, 500)
    }
    
    function Login() {
        localStorage.redirect = start + `/flows/beat_saber_modding?tab=downgrade&checkdowngrade=true`
        location = "https://auth.meta.com/"
    }
    
    function Logout() {
        fetch("/api/logout", {
            method: "POST"
        }).then(res => {
            // open logout page for webview
            localStorage.redirect = start + `/flows/beat_saber_modding?tab=downgrade&checkdowngrade=true`
            location = `https://secure.oculus.com/logout/`
        })
    }
    
    function Downgrade() {
        fetch(start + "/api/downloaddiff", {
            method: "POST", body: JSON.stringify({
                packageName: packageName,
                sourceSha: currentSha,
                targetSha: targetSha,
                targetVersion: targetVersion
            })
        })
        OpenTab("download")
        StartDownloadMonitoring()
    }
    
    var currentSha = ""
    var targetSha = ""
    var targetVersion = ""
    var packageName = "com.beatgames.beatsaber"
    
    function CheckDowngrade() {
        UpdateSupportedBeatSaberVersions().then(() => {
            for(const el of document.getElementsByClassName("bsVersion")) {
                el.innerText = moddedStatus.isInstalled ? moddedStatus.version : "Not installed"
            }
            for(const el of document.getElementsByClassName("supportedBsVersion")) {
                el.innerText = SupportedBeatSaberVersions[0]
            }
            // Check if the latest version is already downloaded by getting backup list of Beat Saber, then checking
            fetch(start + "/api/backups?package=com.beatgames.beatsaber").then(res => res.json().then(j => {
                for(const b of j.backups) {
                    if(b.gameVersion == SupportedBeatSaberVersions[0] && b.isDownloadedFromOculus) {
                        // Game version is already downloaded. Show mod game button
                        console.log("Found backup for latest version, showing mod game button")
                        // emulate finished download
                        lastDownloadProgress = {
                            version: b.gameVersion,
                            packageName: "com.beatgames.beatsaber",
                            backupName: b.backupName
                        }
                        document.getElementById("downgradeLogin").style.display = `none`
                        document.getElementById("downgradeDowngrade").style.display = `block`
                        document.getElementById("downloadbsversion").innerText = b.gameVersion
                        OpenTab("downloaddone")
                        return;
                    }
                }
                
                // Get current version sha

                fetch(start + "/api/currentsha256").then(res => res.json().then(json => {
                    currentSha = json.msg
                    console.log(currentSha)
                    fetch("https://raw.githubusercontent.com/ComputerElite/APKDowngrader/main/versions.json").then(res => res.json().then(patches => {
                        patches = patches.versions.filter(x => x.SSHA256 == currentSha && x.TV == SupportedBeatSaberVersions[0])
                        if(patches.length <= 0) {
                            // No patches found
                            OpenTab("patcheserror")
                        } else {
                            // Patches found
                            OpenTab("downgradeDowngrade")
                        }
                        targetSha = patches[0].TSHA256
                        targetVersion = patches[0].TV
                        console.log(targetSha)
                        console.log(targetVersion)
                    }))
                }))
            }))
        })
    }
    
    var moddedStatus = {}
    
    function UpdateModdedStatus() {
        return new Promise((resolve, reject) => {
            fetch(start + "/api/patching/getmodstatus?package=com.beatgames.beatsaber").then(res => res.json().then(j => {
                moddedStatus = j;
                resolve();
            }))
        })
    }
    
    var qavsConfig = {}
    
    function UpdateQAVSConfig() {
        return new Promise((resolve, reject) => {
            fetch(start + `/api/questappversionswitcher/config`).then(res => res.json().then(j => {
                qavsConfig = j;
                resolve();
            }))
        })
    }
    
    var patchReport = {}

    function InstallCoreModsAndGetMods() {
        UpdateModdedStatus().then(res => {
            fetch(start + `/api/mods/installfromurl`, {
                method: "POST",
                body: `https://oculusdb.rui2015.me/api/coremodsdownload/${moddedStatus.version}.qmod`
            }).then(res => {
                localStorage.openMainDefault = true
                location = start + "/?tab=mods"
            })
        })
    }

    function GetMods() {
        location = start + "/?tab=mods"
    }
    
    function PatchDone() {
        modgameloader.style.display = "none"
        OpenTab("afterpatch")
    }
    
    function RestoreBackup() {
        location = start + `/?package=com.beatgames.beatsaber&backup=${patchReport.backupName}&restorenow=true&noaccesscheck=true&afterrestore=${encodeURIComponent(`/flows/beat_saber_modding?tab=afterrestore`)}`
    }
    
    function ResetPatchPage() {

        document.getElementById("modgamebutton").style.display = "block"
        modgameloader.style.display = "none"
    }
    
    function PatchGame() {
        const patchOptions = {
            otherPermissions: [],
            debug: false,
            handTracking: true,
            handTrackingVersion: 0, // Default
            externalStorage: true,
            openXR: true,
            modloader: 0 // QuestLoader = 0, Scotland2 = 1 
        }
        document.getElementById("modgamebutton").style.display = "none"
        patchInProgressContainer.style.display = "block"
        modgameloader.style.display = "block"
        patchingStatus.className = ""
        patchingStatus.classList.add("text")
        fetch(start + `/api/patching/patchoptions`, {
            method: "POST",
            body: JSON.stringify(patchOptions)
        }).then(res => {
            fetch(start + "/api/patching/patchapk" + patchExtras, {
                method: "POST"
            }).then(res => {
                res.json().then(j => {
                    if (j.success) {
                        patchingStatus.innerHTML = j.msg
                        var i = setInterval(() => {
                            fetch(start + "/api/patching/patchstatus").then(res => {
                                res.json().then(j => {
                                    patchReport = j
                                    if (j.done) {
                                        patchingStatus.innerHTML = j.currentOperation
                                        patchingStatus.classList.remove("text")
                                        patchingStatus.classList.add("success")
                                        clearInterval(i)
                                        PatchDone()
                                    } else if (j.error) {
                                        patchingStatus.innerHTML = j.errorText
                                        patchingStatus.classList.remove("text")
                                        patchingStatus.classList.add("error")
                                        ResetPatchPage()
                                        clearInterval(i)
                                    } else {
                                        patchingStatus.innerHTML =  j.progressString + " - " + j.currentOperation
                                    }
                                })
                            })
                        }, 500);
                    } else {
                        patchingStatus.innerHTML =  j.msg
                        ResetPatchPage()
                        patchingStatus.classList.add("error")
                    }
                })
            })
        })
    }
    
    function UpdateModGamePage() {
        document.getElementById("modgamebsversion").innerText = moddedStatus.version;
    }
    
    function FirstOpen() {
        UpdateModdedStatus().then(() => {
            if(!moddedStatus.isInstalled) {
                // Downgrade
                CheckDowngrade()
            } else {
                UpdateSupportedBeatSaberVersions().then(() => {
                    if(SupportedBeatSaberVersions.length <= 0) {
                        // OH NO; USER IS OFFLINE
                        OpenTab("offline")
                    } else if(SupportedBeatSaberVersions[0] == moddedStatus.version) {
                        // Continue with modding

                        if(moddedStatus.isPatched) {
                            // Already modded
                            OpenTab("alreadymodded")
                        } else {
                            // Not modded
                            OpenTab("modgame")
                            UpdateModGamePage()
                        }
                    } else {
                        // Downgrade
                        CheckDowngrade()
                    }
                })
            }
        })
        
    }
    
    var SupportedBeatSaberVersions = []
    
    function UpdateSupportedBeatSaberVersions() {
        return new Promise((resolve, reject) => {
            fetch("https://computerelite.github.io/tools/Beat_Saber/coreMods.json").then(res => res.json().then(j => {
                for(const [key, value] of Object.entries(j)) {
                    SupportedBeatSaberVersions.push(key);
                }
                SupportedBeatSaberVersions.sort()
                SupportedBeatSaberVersions.reverse()
                resolve()
            })).catch(() => {
                SupportedBeatSaberVersions = []
                resolve()
            })
        })
    }
    function Start() {
        location = document.getElementById("options").value;
    }
    
    function OpenTab(section) {
        Array.prototype.forEach.call(document.getElementsByClassName("content"), e => {
            e.className = "content" + (e.id == section ? "" : " hidden")
        })
    }
</script>
</body>
</html>